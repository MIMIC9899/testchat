<!DOCTYPE html>
<html lang="ru" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatOnline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Inter', sans-serif;
    }
    .dark body {
      background-color: #1f2937;
      color: #d1d5db;
    }
    .sidebar {
      transition: transform 0.3s ease-in-out;
    }
    .sidebar-hidden {
      transform: translateX(-100%);
    }
    .content-container {
      transition: margin-left 0.3s ease-in-out;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }
    .dark .loading-spinner {
      border-color: #374151;
      border-top-color: #60a5fa;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .post, .chat-list > div, .chat-window, .auth-form {
      transition: all 0.2s ease-in-out;
    }
    .post:hover, .chat-list > div:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .dark .post:hover, .dark .chat-list > div:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    button {
      transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
    }
    button:hover:not(:disabled) {
      transform: scale(1.05);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .autocomplete {
      max-height: 200px;
      overflow-y: auto;
    }
    @media (max-width: 640px) {
      .sidebar {
        position: fixed;
        z-index: 50;
        top: 0;
        height: 100%;
        width: 80%;
        max-width: 256px;
      }
      .content-container {
        margin-left: 0 !important;
      }
      .sidebar-toggle {
        display: block;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="flex">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar fixed top-0 left-0 w-64 h-full bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-lg z-40">
      <div class="p-4 flex items-center justify-between">
        <h1 class="text-2xl font-bold">ChatOnline</h1>
        <button id="sidebar-toggle" class="sidebar-toggle hidden text-white focus:outline-none sm:hidden">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="nav-links" class="flex flex-col space-y-2 p-4">
        <button onclick="window.showSection('feed')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
          </svg>
          <span>Лента</span>
        </button>
        <button onclick="window.showSection('profile')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span>Профиль</span>
        </button>
        <button onclick="window.showSection('search')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span>Поиск</span>
        </button>
        <button onclick="window.showSection('chats')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
          <span>Чаты</span>
        </button>
        <button onclick="window.showSection('friends')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <span>Друзья</span>
        </button>
        <button onclick="window.showSection('settings')" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-blue-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>Настройки</span>
        </button>
        <button id="logout-btn" onclick="window.logout()" class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-red-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          <span>Выйти</span>
        </button>
      </div>
    </nav>
    <!-- Mobile sidebar toggle button -->
    <button id="sidebar-open" class="sidebar-toggle fixed top-4 left-4 z-50 sm:hidden text-white bg-blue-600 p-2 rounded-lg focus:outline-none">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
    <!-- Main content -->
    <div id="content" class="content-container flex-1 p-6 sm:ml-64 min-h-screen bg-white dark:bg-gray-800">
      <!-- Content will be injected here by app.js -->
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, limit, where, onSnapshot, serverTimestamp, startAfter } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
import { getDatabase, ref, set, get, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCOsNLLxNDckFUIXOfOaMphlr6WlSRBxqA",
  authDomain: "chatonline-42b5a.firebaseapp.com",
  projectId: "chatonline-42b5a",
  storageBucket: "chatonline-42b5a.firebasestorage.app",
  messagingSenderId: "823959172627",
  appId: "1:823959172627:web:76ad14c35304661fac71e6",
  measurementId: "G-7LT3965R88",
};

try {
  const app = initializeApp(firebaseConfig);
  window.auth = getAuth(app);
  window.db = getFirestore(app);
  window.rtdb = getDatabase(app);
} catch (error) {
  console.error("Firebase initialization failed:", error);
  alert("Ошибка инициализации FirebaseGrenstore: " + error.message);
}

let currentUser = null;
let lastPost = null;

onAuthStateChanged(window.auth, user => {
  currentUser = user;
  const navLinks = document.getElementById('nav-links');
  const logoutBtn = document.getElementById('logout-btn');
  if (user) {
    navLinks.style.display = 'block';
    logoutBtn.style.display = 'flex';
    setDoc(doc(db, 'presence', user.uid), {
      online: true,
      lastSeen: serverTimestamp()
    }, { merge: true }).catch(error => {
      console.error("Failed to set presence:", error);
    });
    getDoc(doc(db, 'users', user.uid)).then(doc => {
      if (doc.exists()) {
        const theme = doc.data().theme || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      } else {
        console.warn("User document not found, setting default theme: light");
        document.documentElement.setAttribute('data-theme', 'light');
      }
    }).catch(error => {
      console.error("Failed to load theme:", error);
      document.documentElement.setAttribute('data-theme', 'light');
    });
    window.showSection('feed');
  } else {
    navLinks.style.display = 'none';
    logoutBtn.style.display = 'none';
    document.documentElement.setAttribute('data-theme', 'light');
    if (currentUser) {
      setDoc(doc(db, 'presence', currentUser.uid), {
        online: false,
        lastSeen: serverTimestamp()
      }, { merge: true }).catch(error => {
        console.error("Failed to set offline presence:", error);
      });
    }
    showAuthForm();
  }
});

window.showSection = function(section) {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading-spinner"></div>';
  switch (section) {
    case 'feed': window.loadFeed(); break;
    case 'profile': window.loadProfile(currentUser.uid); break;
    case 'search': showSearch(); break;
    case 'chats': loadChats(); break;
    case 'friends': loadFriends(); break;
    case 'settings': showSettings(); break;
  }
};

window.login = async function(email, password) {
  try {
    await signInWithEmailAndPassword(window.auth, email, password);
  } catch (error) {
    console.error("Login failed:", error);
    alert(`Ошибка входа: ${error.message}`);
  }
};

window.register = async function(email, password, username) {
  try {
    if (username.length > 20) throw new Error("Имя пользователя слишком длинное (макс. 20 символов)");
    const { user } = await createUserWithEmailAndPassword(window.auth, email, password);
    await setDoc(doc(db, 'users', user.uid), {
      username, email, createdAt: serverTimestamp(), messagingPrivacy: 'everyone', bio: '', avatar: '', theme: 'light', profileBackground: ''
    });
    await setDoc(doc(db, 'presence', user.uid), {
      online: true,
      lastSeen: serverTimestamp()
    });
  } catch (error) {
    console.error("Registration failed:", error);
    alert(`Ошибка регистрации: ${error.message}`);
  }
};

window.logout = async function() {
  try {
    await signOut(window.auth);
  } catch (error) {
    console.error("Logout failed:", error);
    alert(`Ошибка выхода: ${error.message}`);
  }
};

function showAuthForm() {
  document.getElementById('content').innerHTML = `
    <div class="auth-form max-w-md mx-auto bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Вход</h2>
      <form onsubmit="event.preventDefault(); window.login(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value)">
        <input id="loginEmail" type="email" placeholder="Email" required class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <input id="loginPassword" type="password" placeholder="Пароль" required class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">Войти</button>
      </form>
      <h2 class="text-2xl font-bold mt-6 mb-4 text-gray-900 dark:text-white">Регистрация</h2>
      <form onsubmit="event.preventDefault(); window.register(document.getElementById('registerEmail').value, document.getElementById('registerPassword').value, document.getElementById('registerUsername').value)">
        <input id="registerUsername" type="text" placeholder="Имя пользователя" maxlength="20" required class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <input id="registerEmail" type="email" placeholder="Email" required class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <input id="registerPassword" type="password" placeholder="Пароль" required class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700 w-full">Зарегистрироваться</button>
      </form>
    </div>
  `;
}

async function rateLimit(action) {
  const userRef = doc(db, 'users', currentUser.uid);
  const user = await getDoc(userRef);
  const lastAction = user.data().lastAction?.[action] || 0;
  if (Date.now() - lastAction < 5000) throw new Error("Слишком частые действия, подождите 5 секунд");
  await updateDoc(userRef, { [`lastAction.${action}`]: Date.now() });
}

async function loadFeed(filter = 'all') {
  try {
    let postsQuery;
    if (filter === 'friends' && currentUser) {
      const friendsSnapshot = await getDocs(query(
        collection(window.db, 'friends'),
        where('status', '==', 'accepted'),
        where('userId1', '==', currentUser.uid)
      ));
      const reverseFriendsSnapshot = await getDocs(query(
        collection(window.db, 'friends'),
        where('status', '==', 'accepted'),
        where('userId2', '==', currentUser.uid)
      ));
      const friendIds = [
        ...friendsSnapshot.docs.map(docSnapshot => docSnapshot.data().userId2),
        ...reverseFriendsSnapshot.docs.map(docSnapshot => docSnapshot.data().userId1)
      ];
      if (friendIds.length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
            <div class="mb-4">
              <button onclick="window.loadFeed('all')" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">Все</button>
              <button onclick="window.loadFeed('friends')" class="bg-gray-300 dark:bg-gray-700 text-black dark:text-white px-4 py-2 rounded">Друзья</button>
            </div>
            <p class="text-gray-500 dark:text-gray-400">Пусто</p>
          </div>
        `;
        return;
      }
      postsQuery = query(
        collection(window.db, 'posts'),
        where('author', 'in', friendIds),
        orderBy('timestamp', 'desc'),
        limit(10)
      );
    } else {
      postsQuery = query(
        collection(window.db, 'posts'),
        orderBy('timestamp', 'desc'),
        limit(10)
      );
    }
    const postsSnapshot = await getDocs(postsQuery);
    lastPost = postsSnapshot.docs[postsSnapshot.docs.length - 1];
    const posts = await Promise.all(postsSnapshot.docs.map(async docSnapshot => {
      const post = docSnapshot.data();
      const authorDoc = await getDoc(doc(window.db, 'users', post.author));
      const commentsSnapshot = await getDocs(query(
        collection(window.db, 'posts', docSnapshot.id, 'comments'),
        orderBy('timestamp', 'asc'),
        limit(3)
      ));
      const comments = await Promise.all(commentsSnapshot.docs.map(async c => {
        const user = await getDoc(doc(db, 'users', c.data().author));
        return {
          id: c.id,
          ...c.data(),
          username: user.exists() ? user.data().username : 'Аноним'
        };
      }));
      return {
        id: docSnapshot.id,
        ...post,
        authorName: authorDoc.exists() ? authorDoc.data().username : 'Аноним',
        authorAvatar: authorDoc.exists() ? authorDoc.data().avatar || 'https://picsum.photos/32' : 'https://picsum.photos/32',
        comments
      };
    }));
    document.getElementById('content').innerHTML = `
      <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
        <div class="mb-4">
          <button onclick="window.loadFeed('all')" class="bg-${filter === 'all' ? 'blue-500 text-white' : 'gray-300 dark:bg-gray-700 text-black dark:text-white'} px-4 py-2 rounded mr-2">Все</button>
          <button onclick="window.loadFeed('friends')" class="bg-${filter === 'friends' ? 'blue-500 text-white' : 'gray-300 dark:bg-gray-700 text-black dark:text-white'} px-4 py-2 rounded">Друзья</button>
        </div>
        <div id="posts" class="space-y-4">
          ${posts.map(post => `
            <div class="post bg-gray-50 dark:bg-gray-700 p-4 rounded fade-in">
              <div class="flex items-center mb-2">
                <img src="${post.authorAvatar}" class="w-8 h-8 rounded-full cursor-pointer" onclick="window.loadProfile('${post.author}')">
                <h4 class="ml-2 font-semibold cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${post.author}')">${post.authorName}</h4>
              </div>
              <p class="text-gray-800 dark:text-gray-200">${post.text}</p>
              <div class="flex items-center space-x-4 mt-2">
                <button onclick="window.toggleLike('${post.id}')" class="flex items-center space-x-1 text-gray-600 dark:text-gray-300 hover:text-red-500">
                  <svg class="w-5 h-5" fill="${post.likes?.includes(currentUser.uid) ? 'red' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span>${post.likes?.length || 0}</span>
                </button>
              </div>
              <div class="mt-2 space-y-2">
                ${post.comments.map(comment => `
                  <div class="text-sm text-gray-600 dark:text-gray-300">
                    <span class="font-semibold">${comment.username}</span>: ${comment.text}
                    ${comment.author === currentUser.uid ? `<button onclick="window.deleteComment('${post.id}', '${comment.id}')" class="text-red-500 hover:text-red-600 ml-2 text-xs">Удалить</button>` : ''}
                  </div>
                `).join('')}
                <form onsubmit="event.preventDefault(); window.addComment('${post.id}', document.getElementById('comment-${post.id}').value)">
                  <input id="comment-${post.id}" maxlength="200" placeholder="Комментарий..." class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                  <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mt-1">Отправить</button>
                </form>
              </div>
              <div class="flex justify-between items-center mt-2">
                <small class="text-gray-500 dark:text-gray-400">${post.timestamp?.toDate().toLocaleString()}</small>
                ${post.author === currentUser.uid ? `
                  <button onclick="window.deletePost('${post.id}')" class="text-red-500 hover:text-red-700">Удалить</button>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
        <button id="load-more" onclick="window.loadMorePosts('${filter}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4 w-full">Загрузить еще</button>
      </div>
    `;
    if (posts.length < 10) document.getElementById('load-more').style.display = 'none';
  } catch (error) {
    console.error("Feed load failed:", error);
    alert(`Ошибка загрузки ленты: ${error.message}`);
  }
}
window.loadFeed = loadFeed;

window.loadMorePosts = async function(filter) {
  try {
    
    let postsQuery;
    if (filter === 'friends') {
      const friendsSnapshot = await getDocs(query(
        collection(window.db, 'friends'),
        where('status', '==', 'accepted'),
        where('userId1', '==', currentUser.uid)
      ));
      const reverseFriendsSnapshot = await getDocs(query(
        collection(window.db, 'friends'),
        where('status', '==', 'accepted'),
        where('userId2', '==', currentUser.uid)
      ));
      const friendIds = [
        ...friendsSnapshot.docs.map(docSnapshot => docSnapshot.data().userId2),
        ...reverseFriendsSnapshot.docs.map(docSnapshot => docSnapshot.data().userId1)
      ];
      if (friendIds.length === 0) return;
      postsQuery = query(
        collection(window.db, 'posts'),
        where('author', 'in', friendIds),
        orderBy('timestamp', 'desc'),
        startAfter(lastPost),
        limit(10)
      );
    } else {
      postsQuery = query(
        collection(window.db, 'posts'),
        orderBy('timestamp', 'desc'),
        startAfter(lastPost),
        limit(10)
      );
    }
    const postsSnapshot = await getDocs(postsQuery);
    lastPost = postsSnapshot.docs[postsSnapshot.docs.length - 1];
    const posts = await Promise.all(postsSnapshot.docs.map(async docSnapshot => {
      const post = docSnapshot.data();
      const authorDoc = await getDoc(doc(window.db, 'users', post.author));
      const commentsSnapshot = await getDocs(query(
        collection(window.db, 'posts', docSnapshot.id, 'comments'),
        orderBy('timestamp', 'asc'),
        limit(3)
      ));
      const comments = await Promise.all(commentsSnapshot.docs.map(async c => {
        const user = await getDoc(doc(db, 'users', c.data().author));
        return {
          id: c.id,
          ...c.data(),
          username: user.exists() ? user.data().username : 'Аноним'
        };
      }));
      return {
        id: docSnapshot.id,
        ...post,
        authorName: authorDoc.exists() ? authorDoc.data().username : 'Аноним',
        authorAvatar: authorDoc.exists() ? authorDoc.data().avatar || 'https://picsum.photos/32' : 'https://picsum.photos/32',
        comments
      };
    }));
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML += posts.map(post => `
      <div class="post bg-gray-50 dark:bg-gray-700 p-4 rounded fade-in">
        <div class="flex items-center mb-2">
          <img src="${post.authorAvatar}" class="w-8 h-8 rounded-full cursor-pointer" onclick="window.loadProfile('${post.author}')">
          <h4 class="ml-2 font-semibold cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${post.author}')">${post.authorName}</h4>
        </div>
        <p class="text-gray-800 dark:text-gray-200">${post.text}</p>
        <div class="flex items-center space-x-4 mt-2">
          <button onclick="window.toggleLike('${post.id}')" class="flex items-center space-x-1 text-gray-600 dark:text-gray-300 hover:text-red-500">
            <svg class="w-5 h-5" fill="${post.likes?.includes(currentUser.uid) ? 'red' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <span>${post.likes?.length || 0}</span>
          </button>
        </div>
        <div class="mt-2 space-y-2">
          ${post.comments.map(comment => `
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <span class="font-semibold">${comment.username}</span>: ${comment.text}
              ${comment.author === currentUser.uid ? `<button onclick="window.deleteComment('${post.id}', '${comment.id}')" class="text-red-500 hover:text-red-600 ml-2 text-xs">Удалить</button>` : ''}
            </div>
          `).join('')}
          <form onsubmit="event.preventDefault(); window.addComment('${post.id}', document.getElementById('comment-${post.id}').value)">
            <input id="comment-${post.id}" maxlength="200" placeholder="Комментарий..." class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mt-1">Отправить</button>
          </form>
        </div>
        <div class="flex justify-between items-center mt-2">
          <small class="text-gray-500 dark:text-gray-400">${post.timestamp?.toDate().toLocaleString()}</small>
          ${post.author === currentUser.uid ? `
            <button onclick="window.deletePost('${post.id}')" class="text-red-500 hover:text-red-700">Удалить</button>
          ` : ''}
        </div>
      </div>
    `).join('');
    if (posts.length < 10) document.getElementById('load-more').style.display = 'none';
  } catch (error) {
    console.error("Load more posts failed:", error);
    alert(`Ошибка загрузки постов: ${error.message}`);
  }
};

window.toggleLike = async function(postId) {
  try {
    await rateLimit('like');
    const postRef = doc(db, 'posts', postId);
    const post = await getDoc(postRef);
    const likes = post.data().likes || [];
    if (likes.includes(currentUser.uid)) {
      await updateDoc(postRef, { likes: likes.filter(id => id !== currentUser.uid) });
    } else {
      await updateDoc(postRef, { likes: [...likes, currentUser.uid] });
    }
    loadFeed();
  } catch (error) {
    console.error("Toggle like failed:", error);
    alert(`Ошибка: ${error.message}`);
  }
};

window.addComment = async function(postId, text) {
  try {
    if (!text.trim()) return;
    if (text.length > 200) throw new Error("Комментарий слишком длинный (макс. 200 символов)");
    await rateLimit('comment');
    await addDoc(collection(db, 'posts', postId, 'comments'), {
      text, author: currentUser.uid, timestamp: serverTimestamp()
    });
    document.getElementById(`comment-${postId}`).value = '';
    loadFeed();
  } catch (error) {
    console.error("Add comment failed:", error);
    alert(`Ошибка: ${error.message}`);
  }
};

window.deleteComment = async function(postId, commentId) {
  try {
    await deleteDoc(doc(db, 'posts', postId, 'comments', commentId));
    loadFeed();
  } catch (error) {
    console.error("Delete comment failed:", error);
    alert(`Ошибка: ${error.message}`);
  }
};

async function loadProfile(uid) {
  try {
    
    const userDoc = await getDoc(doc(db, 'users', uid));
    
    if (!userDoc.exists()) throw new Error("Пользователь не найден");
    const postsSnapshot = await getDocs(query(collection(db, 'posts'), where('author', '==', uid), orderBy('timestamp', 'desc')));
    
    const friendsSnapshot1 = await getDocs(query(collection(db, 'friends'), where('userId1', '==', uid), where('status', '==', 'accepted')));
    const friendsSnapshot2 = await getDocs(query(collection(db, 'friends'), where('userId2', '==', uid), where('status', '==', 'accepted')));
    
    
    // Подсчет уникальных друзей
    const friendIds = new Set();
    friendsSnapshot1.docs.forEach(doc => {
      friendIds.add(doc.data().userId2);
    });
    friendsSnapshot2.docs.forEach(doc => {
      friendIds.add(doc.data().userId1);
    });
    const friendCount = friendIds.size;
    

    let friendDoc = null;
    if (currentUser && currentUser.uid !== uid) {
      friendDoc = await getDoc(doc(db, 'friends', `${currentUser.uid}_${uid}`));
      if (!friendDoc.exists()) {
        friendDoc = await getDoc(doc(db, 'friends', `${uid}_${currentUser.uid}`));
      }
      
    }
    const presenceDoc = await getDoc(doc(db, 'presence', uid));
    const presence = presenceDoc.exists() ? presenceDoc.data() : { online: false };
    
    const user = userDoc.data();
    const friendStatus = friendDoc && friendDoc.exists() ? friendDoc.data().status : null;
    const friendDocId = friendDoc && friendDoc.exists() ? friendDoc.id : null;
    const posts = await Promise.all(postsSnapshot.docs.map(async docSnapshot => {
      const post = docSnapshot.data();
      const commentsSnapshot = await getDocs(query(
        collection(db, 'posts', docSnapshot.id, 'comments'),
        orderBy('timestamp', 'asc'),
        limit(3)
      ));
      const comments = await Promise.all(commentsSnapshot.docs.map(async c => {
        const user = await getDoc(doc(db, 'users', c.data().author));
        return {
          id: c.id,
          ...c.data(),
          username: user.exists() ? user.data().username : 'Аноним'
        };
      }));
      return {
        id: docSnapshot.id,
        ...post,
        comments
      };
    }));
    document.getElementById('content').innerHTML = `
      <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow" style="background-image: url('${user.profileBackground || ''}'); background-size: cover; background-position: center;">
        <div class="flex items-center mb-4">
          <img src="${user.avatar || 'https://picsum.photos/48'}" class="w-12 h-12 rounded-full" alt="Avatar">
          <div class="ml-4">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${user.username}</h2>
            <div class="flex items-center space-x-2">
              ${user.bio ? `<p class="text-gray-600 dark:text-gray-300">${user.bio}</p>` : ''}
              <span class="w-3 h-3 rounded-full ${presence.online ? 'bg-green-500' : 'bg-gray-500'}"></span>
            </div>
          </div>
        </div>
        <div class="mb-4 text-gray-600 dark:text-gray-300">
          <span>Постов: ${postsSnapshot.size}</span> | <span>Друзей: ${friendCount}</span>
        </div>
        ${uid === currentUser.uid ? `
          <form onsubmit="event.preventDefault(); window.updateProfile(document.getElementById('username').value, document.getElementById('bio').value, document.getElementById('avatar').value, document.getElementById('profileBackground').value)" class="mb-4">
            <input id="username" type="text" placeholder="Имя пользователя" value="${user.username || ''}" maxlength="20" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <textarea id="bio" placeholder="О себе" maxlength="200" class="w-full p-2 border rounded mt-2 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">${user.bio || ''}</textarea>
            <input id="avatar" type="url" placeholder="URL аватара" value="${user.avatar || ''}" class="w-full p-2 border rounded mt-2 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <input id="profileBackground" type="url" placeholder="URL фонового изображения" value="${user.profileBackground || ''}" class="w-full p-2 border rounded mt-2 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">Обновить профиль</button>
          </form>
          <form onsubmit="event.preventDefault(); window.addPost(document.getElementById('postText').value)" class="mb-4">
            <textarea id="postText" placeholder="Что нового?" maxlength="500" required class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></textarea>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">Опубликовать</button>
          </form>
        ` : currentUser ? `
          <div class="mb-4 flex space-x-2">
            ${friendStatus === 'accepted' ? `
              <button onclick="window.removeFriend('${uid}', '${friendDocId}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Удалить из друзей</button>
            ` : friendStatus === 'pending' && friendDocId === `${currentUser.uid}_${uid}` ? `
              <button class="bg-gray-500 text-white px-4 py-2 rounded" disabled>Запрос отправлен</button>
            ` : friendStatus === 'pending' && friendDocId === `${uid}_${currentUser.uid}` ? `
              <button onclick="window.acceptFriendRequest('${uid}', '${friendDocId}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Принять запрос</button>
              <button onclick="window.declineFriendRequest('${uid}', '${friendDocId}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2">Отклонить</button>
            ` : `
              <button onclick="window.addFriend('${uid}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Добавить в друзья</button>
            `}
            <button onclick="window.startChat('${uid}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Написать</button>
          </div>
        ` : ''}
        <div class="space-y-4 mt-4">
          ${posts.map(post => `
            <div class="post bg-gray-50 dark:bg-gray-700 p-4 rounded fade-in">
              <p class="text-gray-800 dark:text-gray-200">${post.text}</p>
              <div class="flex items-center space-x-4 mt-2">
                <button onclick="window.toggleLike('${post.id}')" class="flex items-center space-x-1 text-gray-600 dark:text-gray-300 hover:text-red-500">
                  <svg class="w-5 h-5" fill="${post.likes?.includes(currentUser.uid) ? 'red' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span>${post.likes?.length || 0}</span>
                </button>
              </div>
              <div class="mt-2 space-y-2">
                ${post.comments.map(comment => `
                  <div class="text-sm text-gray-600 dark:text-gray-300">
                    <span class="font-semibold">${comment.username}</span>: ${comment.text}
                    ${comment.author === currentUser.uid ? `<button onclick="window.deleteComment('${post.id}', '${comment.id}')" class="text-red-500 hover:text-red-600 ml-2 text-xs">Удалить</button>` : ''}
                  </div>
                `).join('')}
                <form onsubmit="event.preventDefault(); window.addComment('${post.id}', document.getElementById('comment-${post.id}').value)">
                  <input id="comment-${post.id}" maxlength="200" placeholder="Комментарий..." class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                  <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mt-1">Отправить</button>
                </form>
              </div>
              <div class="flex justify-between items-center mt-2">
                <small class="text-gray-500 dark:text-gray-400">${post.timestamp?.toDate().toLocaleString()}</small>
                ${uid === currentUser.uid ? `
                  <button onclick="window.deletePost('${post.id}')" class="text-red-500 hover:text-red-700">Удалить</button>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } catch (error) {
    console.error("Profile load failed:", error, "UID:", uid);
    alert(`Ошибка загрузки профиля: ${error.message}`);
    window.showSection('feed');
  }
}
window.loadProfile = loadProfile;

window.addPost = async function(text) {
  try {
    if (text.length > 500) throw new Error("Пост слишком длинный (макс. 500 символов)");
    await rateLimit('post');
    
    await addDoc(collection(window.db, 'posts'), {
      text, author: currentUser.uid, timestamp: serverTimestamp(), likes: []
    });
    window.loadProfile(currentUser.uid);
  } catch (error) {
    console.error("Post creation failed:", error);
    alert(`Ошибка публикации: ${error.message}`);
  }
};

window.deletePost = async function(postId) {
  try {
    
    await deleteDoc(doc(window.db, 'posts', postId));
    window.loadProfile(currentUser.uid);
  } catch (error) {
    console.error("Post deletion failed:", error);
    alert(`Ошибка удаления записи: ${error.message}`);
  }
};

async function showSearch() {
  
  document.getElementById('content').innerHTML = `
    <div class="relative">
      <form onsubmit="event.preventDefault(); window.handleSearch(document.getElementById('searchInput').value)">
        <input id="searchInput" type="text" placeholder="Имя пользователя" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">Поиск</button>
      </form>
      <div id="searchResults" class="autocomplete absolute w-full bg-white dark:bg-gray-900 shadow-lg rounded-lg mt-1 z-10"></div>
    </div>
  `;
  // Autocomplete
  let debounceTimer;
  document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => handleSearch(this.value, true), 300);
  });
}

window.handleSearch = async function(username, isAutocomplete = false) {
  try {
    
    const snapshot = await getDocs(query(
      collection(window.db, 'users'),
      where('username', '>=', username),
      where('username', '<=', username + '\uf8ff'),
      limit(isAutocomplete ? 5 : 20)
    ));
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = snapshot.docs.map(docSnapshot => {
      const user = docSnapshot.data();
      const presence = getDoc(doc(db, 'presence', docSnapshot.id)).then(d => d.data() || { online: false });
      return `
        <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow mb-2 flex justify-between items-center fade-in">
          <div class="flex items-center">
            <img src="${user.avatar || 'https://picsum.photos/32'}" class="w-8 h-8 rounded-full">
            <span class="ml-2 cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${docSnapshot.id}')">${user.username}</span>
            <span class="w-2 h-2 rounded-full ${presence.then(p => p.online ? 'bg-green-500' : 'bg-gray-500')} ml-2"></span>
          </div>
          <button onclick="window.startChat('${docSnapshot.id}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Написать</button>
        </div>
      `;
    }).join('');
    if (!isAutocomplete) resultsContainer.classList.remove('autocomplete', 'absolute', 'w-full', 'shadow-lg', 'rounded-lg', 'mt-1', 'z-10');
  } catch (error) {
    console.error("Search failed:", error);
    alert(`Ошибка поиска: ${error.message}`);
  }
};

window.startChat = async function(targetUserId) {
  try {
    
    await rateLimit('chat');
    const currentUserId = currentUser.uid;
    if (!currentUserId || !targetUserId) {
      throw new Error("Некорректные ID пользователей");
    }
    const targetUserDoc = await getDoc(doc(window.db, 'users', targetUserId));
    if (!targetUserDoc.exists()) throw new Error("Пользователь не найден");
    const targetPrivacy = targetUserDoc.data().messagingPrivacy || 'everyone';
    if (targetPrivacy === 'friends') {
      const friendDoc1 = await getDoc(doc(window.db, 'friends', `${currentUserId}_${targetUserId}`));
      const friendDoc2 = await getDoc(doc(window.db, 'friends', `${targetUserId}_${currentUserId}`));
      if (!friendDoc1.exists() && !friendDoc2.exists() || 
          (friendDoc1.exists() && friendDoc1.data().status !== 'accepted') || 
          (friendDoc2.exists() && friendDoc2.data().status !== 'accepted')) {
        throw new Error("Вы можете писать только друзьям этого пользователя");
      }
    }
    const querySnapshot = await getDocs(query(
      collection(window.db, 'chats'),
      where('participants', 'array-contains', currentUserId)
    ));
    const existingChat = querySnapshot.docs.find(docSnapshot => {
      const participants = docSnapshot.data().participants;
      return Array.isArray(participants) && participants.includes(targetUserId);
    });
    if (existingChat) {
      
      return openChat(existingChat.id);
    }
    const chatRef = await addDoc(collection(window.db, 'chats'), {
      participants: [currentUserId, targetUserId],
      createdAt: serverTimestamp(),
      lastMessage: null
    });
    
    openChat(chatRef.id);
  } catch (error) {
    console.error("Chat creation failed:", error);
    alert(`Ошибка создания чата: ${error.message}`);
    window.showSection('search');
  }
};

async function loadChats() {
  try {
    
    const chatsSnapshot = await getDocs(query(
      collection(db, 'chats'),
      where('participants', 'array-contains', currentUser.uid)
    ));
    
    const chats = await Promise.all(chatsSnapshot.docs.map(async docSnapshot => {
      const data = docSnapshot.data();
      if (!data.participants || !Array.isArray(data.participants)) {
        console.warn(`Invalid participants in chat ${docSnapshot.id}:`, data.participants);
        return null;
      }
      const targetUserId = data.participants.find(id => id !== currentUser.uid);
      if (!targetUserId) {
        console.warn(`No target user found in chat ${docSnapshot.id}`);
        return null;
      }
      const userDoc = await getDoc(doc(db, 'users', targetUserId));
      
      const presenceDoc = await getDoc(doc(db, 'presence', targetUserId));
      const presence = presenceDoc.exists() ? presenceDoc.data() : { online: false };
      
      return {
        id: docSnapshot.id,
        username: userDoc.exists() ? userDoc.data().username : 'Неизвестный',
        lastMessage: data.lastMessage,
        targetUserId,
        targetUserAvatar: userDoc.exists() ? userDoc.data().avatar || 'https://picsum.photos/40' : 'https://picsum.photos/40',
        online: presence.online
      };
    }));
    const validChats = chats.filter(chat => chat !== null);
    
    document.getElementById('content').innerHTML = `
      <div class="chat-list space-y-2">
        ${validChats.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">Пусто</p>' : validChats.map(chat => `
          <div onclick="window.openChat('${chat.id}')" class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer fade-in">
            <div class="flex items-center">
              <img src="${chat.targetUserAvatar}" class="w-10 h-10 rounded-full">
              <div class="ml-3">
                <h3 class="font-semibold text-gray-900 dark:text-white">${chat.username}</h3>
                ${chat.lastMessage?.text ? `<p class="text-gray-600 dark:text-gray-300 truncate">${chat.lastMessage.text}</p>` : ''}
                <span class="w-2 h-2 rounded-full ${chat.online ? 'bg-green-500' : 'bg-gray-500'} inline-block"></span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  } catch (error) {
    console.error("Chats load failed:", error);
    alert(`Ошибка загрузки чатов: ${error.message}`);
  }
}

window.openChat = async function(chatId) {
  try {
    
    const chatDoc = await getDoc(doc(db, 'chats', chatId));
    if (!chatDoc.exists()) throw new Error("Чат не найден");
    const data = chatDoc.data();
    if (!data.participants.includes(currentUser.uid)) throw new Error("Нет доступа к чату");
    const targetUserId = data.participants.find(id => id !== currentUser.uid);
    const userDoc = await getDoc(doc(db, 'users', targetUserId));
    const presenceDoc = await getDoc(doc(db, 'presence', targetUserId));
    const presenceData = presenceDoc.exists() ? presenceDoc.data() : { online: false };
    const messagesSnapshot = await getDocs(query(
      collection(db, 'chats', chatId, 'messages'),
      orderBy('timestamp', 'asc')
    ));
    const messages = messagesSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    document.getElementById('content').innerHTML = `
      <div class="chat bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
        <div class="flex items-center mb-4">
          <img src="${userDoc.exists() ? userDoc.data().avatar || 'https://picsum.photos/40' : 'https://picsum.photos/40'}" class="w-10 h-10 rounded-full">
          <h2 class="ml-3 text-xl font-semibold text-gray-900 dark:text-white">${userDoc.exists() ? userDoc.data().username : 'Неизвестный'}</h2>
          <span class="w-2 h-2 rounded-full ${presenceData.online ? 'bg-green-500' : 'bg-gray-500'} ml-2"></span>
        </div>
        <div class="messages space-y-2 max-h-96 overflow-y-auto">
          ${messages.map(doc => `
            <div class="${doc.sender === currentUser.uid ? 'text-right' : 'text-left'}">
              <div class="inline-block p-2 rounded-lg ${doc.sender === currentUser.uid ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-white'}">
                ${doc.text}
                ${doc.sender === currentUser.uid ? `<button onclick="window.deleteMessage('${chatId}', '${doc.id}')" class="text-red-300 hover:text-red-100 ml-2 text-xs">Удалить</button>` : ''}
              </div>
              <small class="block text-gray-500 dark:text-gray-400">${doc.timestamp?.toDate().toLocaleString()}</small>
            </div>
          `).join('')}
        </div>
        <form onsubmit="event.preventDefault(); window.sendMessage('${chatId}', document.getElementById('message').value)" class="mt-4 flex">
          <input id="message" maxlength="500" placeholder="Сообщение..." required class="flex-1 p-2 border rounded-l bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">Отправить</button>
        </form>
      </div>
    `;
    // Real-time listener
    onSnapshot(query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp', 'asc')), snapshot => {
      const messagesDiv = document.querySelector('.messages');
      if (messagesDiv) {
        messagesDiv.innerHTML = snapshot.docs.map(doc => {
          const m = doc.data();
          return `
            <div class="${m.sender === currentUser.uid ? 'text-right' : 'text-left'}">
              <div class="inline-block p-2 rounded-lg ${m.sender === currentUser.uid ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-white'}">
                ${m.text}
                ${m.sender === currentUser.uid ? `<button onclick="window.deleteMessage('${chatId}', '${doc.id}')" class="text-red-300 hover:text-red-100 ml-2 text-xs">Удалить</button>` : ''}
              </div>
              <small class="block text-gray-500 dark:text-gray-400">${m.timestamp?.toDate().toLocaleString()}</small>
            </div>
          `;
        }).join('');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } else {
        console.warn("Messages div not found");
      }
    });
  } catch (error) {
    console.error("Chat open failed:", error);
    alert(`Ошибка открытия чата: ${error.message}`);
    window.showSection('chats');
  }
};
window.openChat = openChat;

window.sendMessage = async function(chatId, text) {
  try {
    
    if (!text.trim()) throw new Error("Сообщение не может быть пустым");
    await addDoc(collection(db, 'chats', chatId, 'messages'), {
      text: text.trim(),
      sender: currentUser.uid,
      timestamp: serverTimestamp(),
      read: false
    });
    await updateDoc(doc(db, 'chats', chatId), {
      lastMessage: { text: text.trim(), sender: currentUser.uid, timestamp: serverTimestamp() }
    });
    const messageInput = document.getElementById('message');
    if (messageInput) {
      messageInput.value = '';
    } else {
      console.warn("Message input element not found");
    }
    
  } catch (error) {
    console.error("Message sending failed:", error);
    alert(`Ошибка отправки сообщения: ${error.message}`);
  }
};

window.deleteMessage = async function(chatId, messageId) {
  try {
    
    await deleteDoc(doc(window.db, 'chats', chatId, 'messages', messageId));
    
  } catch (error) {
    console.error("Message deletion failed:", error);
    alert(`Ошибка удаления сообщения: ${error.message}`);
  }
};

window.addFriend = async function(friendId) {
  try {
    await rateLimit('friend_request');
    
    if (currentUser.uid === friendId) throw new Error("Нельзя добавить себя в друзья");
    const friendDocId = `${currentUser.uid}_${friendId}`;
    const existingDoc = await getDoc(doc(window.db, 'friends', friendDocId));
    if (existingDoc.exists()) throw new Error("Запрос уже отправлен или пользователь в друзьях");
    await setDoc(doc(window.db, 'friends', friendDocId), {
      userId1: currentUser.uid,
      userId2: friendId,
      status: 'pending',
      createdAt: serverTimestamp()
    });
    window.loadProfile(friendId);
  } catch (error) {
    console.error("Add friend failed:", error);
    alert(`Ошибка добавления друга: ${error.message}`);
  }
};

window.removeFriend = async function(friendId, friendDocId) {
  try {
    
    const docId1 = `${currentUser.uid}_${friendId}`;
    const docId2 = `${friendId}_${currentUser.uid}`;
    await Promise.all([
      deleteDoc(doc(db, 'friends', docId1)).catch(() => console.log(`Document ${docId1} does not exist, skipping`)),
      deleteDoc(doc(db, 'friends', docId2)).catch(() => console.log(`Document ${docId2} does not exist, skipping`))
    ]);
    window.loadFriends();
  } catch (error) {
    console.error("Remove friend failed:", error);
    alert(`Ошибка удаления друга: ${error.message}`);
  }
};

window.acceptFriendRequest = async function(requesterId, friendDocId) {
  try {
    
    await updateDoc(doc(window.db, 'friends', friendDocId), {
      status: 'accepted'
    });
    const reverseDocId = `${currentUser.uid}_${requesterId}`;
    await setDoc(doc(window.db, 'friends', reverseDocId), {
      userId1: currentUser.uid,
      userId2: requesterId,
      status: 'accepted',
      createdAt: serverTimestamp()
    });
    loadFriends();
  } catch (error) {
    console.error("Accept friend request failed:", error);
    alert(`Ошибка принятия запроса: ${error.message}`);
  }
};

window.declineFriendRequest = async function(friendId, friendDocId) {
  try {
    
    await deleteDoc(doc(window.db, 'friends', friendDocId));
    loadFriends();
  } catch (error) {
    console.error("Decline friend request failed:", error);
    alert(`Ошибка отклонения запроса: ${error.message}`);
  }
};

window.loadFriends = async function() {
  try {
    
    // Запросы на принятых друзей
    const friendsSnapshot1 = await getDocs(query(
      collection(db, 'friends'),
      where('userId1', '==', currentUser.uid),
      where('status', '==', 'accepted')
    ));
    const friendsSnapshot2 = await getDocs(query(
      collection(db, 'friends'),
      where('userId2', '==', currentUser.uid),
      where('status', '==', 'accepted')
    ));
    // Запросы на отправленные заявки
    const sentRequestsSnapshot = await getDocs(query(
      collection(db, 'friends'),
      where('userId1', '==', currentUser.uid),
      where('status', '==', 'pending')
    ));
    // Запросы на полученные заявки
    const receivedRequestsSnapshot = await getDocs(query(
      collection(db, 'friends'),
      where('userId2', '==', currentUser.uid),
      where('status', '==', 'pending')
    ));
    
    

    // Обработка друзей
    const friendIds = new Set(); // Избегаем дублирования
    const friends = await Promise.all([...friendsSnapshot1.docs, ...friendsSnapshot2.docs].map(async friendDoc => {
      const friendData = friendDoc.data();
      const friendId = friendData.userId1 === currentUser.uid ? friendData.userId2 : friendData.userId1;
      if (friendIds.has(friendId)) return null; // Пропускаем дубли
      friendIds.add(friendId);
      const userDoc = await getDoc(doc(db, 'users', friendId));
      if (!userDoc.exists()) {
        console.warn(`User document not found for friendId: ${friendId}`);
        return null; // Пропускаем, если пользователь не существует
      }
      const presenceDoc = await getDoc(doc(db, 'presence', friendId));
      const presenceData = presenceDoc.exists() ? presenceDoc.data() : { online: false };
      return {
        id: friendId,
        username: userDoc.data().username || 'Неизвестный',
        avatar: userDoc.data().avatar || 'https://picsum.photos/32',
        online: presenceData.online,
        docId: friendDoc.id // Сохраняем ID документа для удаления
      };
    })).then(results => results.filter(friend => friend !== null));

    // Обработка отправленных заявок
    const sentRequests = await Promise.all(sentRequestsSnapshot.docs.map(async friendDoc => {
      const friendData = friendDoc.data();
      const friendId = friendData.userId2;
      const userDoc = await getDoc(doc(db, 'users', friendId));
      if (!userDoc.exists()) {
        console.warn(`User document not found for sent request friendId: ${friendId}`);
        return null;
      }
      return {
        id: friendId,
        username: userDoc.data().username || 'Неизвестный',
        avatar: userDoc.data().avatar || 'https://picsum.photos/32',
        docId: friendDoc.id
      };
    })).then(results => results.filter(request => request !== null));

    // Обработка полученных заявок
    const receivedRequests = await Promise.all(receivedRequestsSnapshot.docs.map(async friendDoc => {
      const friendData = friendDoc.data();
      const friendId = friendData.userId1;
      const userDoc = await getDoc(doc(db, 'users', friendId));
      if (!userDoc.exists()) {
        console.warn(`User document not found for received request friendId: ${friendId}`);
        return null;
      }
      return {
        id: friendId,
        username: userDoc.data().username || 'Неизвестный',
        avatar: userDoc.data().avatar || 'https://picsum.photos/32',
        docId: friendDoc.id
      };
    })).then(results => results.filter(request => request !== null));

    document.getElementById('content').innerHTML = `
      <div class="friends-list space-y-4 bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Друзья</h2>
        <div class="space-y-2">
          ${friends.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">Нет друзей</p>' : friends.map(friend => `
            <div class="p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg flex justify-between items-center fade-in">
              <div class="flex items-center">
                <img src="${friend.avatar}" class="w-8 h-8 rounded-full">
                <span class="ml-2 cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${friend.id}')">${friend.username}</span>
                <span class="w-2 h-2 rounded-full ${friend.online ? 'bg-green-500' : 'bg-gray-500'} ml-2"></span>
              </div>
              <button onclick="window.removeFriend('${friend.id}', '${friend.docId}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Удалить</button>
            </div>
          `).join('')}
        </div>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mt-4">Отправленные заявки</h2>
        <div class="space-y-2">
          ${sentRequests.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">Нет отправленных заявок</p>' : sentRequests.map(request => `
            <div class="p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg flex justify-between items-center fade-in">
              <div class="flex items-center">
                <img src="${request.avatar}" class="w-8 h-8 rounded-full">
                <span class="ml-2 cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${request.id}')">${request.username}</span>
              </div>
              <button class="bg-gray-500 text-white px-2 py-1 rounded" disabled>Ожидание</button>
            </div>
          `).join('')}
        </div>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mt-4">Полученные заявки</h2>
        <div class="space-y-2">
          ${receivedRequests.length === 0 ? '<p class="text-gray-500 dark:text-gray-400">Нет полученных заявок</p>' : receivedRequests.map(request => `
            <div class="p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg flex justify-between items-center fade-in">
              <div class="flex items-center">
                <img src="${request.avatar}" class="w-8 h-8 rounded-full">
                <span class="ml-2 cursor-pointer text-gray-900 dark:text-white" onclick="window.loadProfile('${request.id}')">${request.username}</span>
              </div>
              <div>
                <button onclick="window.acceptFriendRequest('${request.id}', '${request.docId}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-700 mr-2">Принять</button>
                <button onclick="window.declineFriendRequest('${request.id}', '${request.docId}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Отклонить</button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } catch (error) {
    console.error("Friends load failed:", error);
    alert(`Ошибка загрузки друзей: ${error.message}`);
  }
};

function isValidUrl(url) {
  try {
    new URL(url);
    return url.startsWith('https://'); // Проверяем, что это HTTPS URL
  } catch {
    return false;
  }
}

window.updateProfile = async function(username, bio, avatar, profileBackground) {
  try {
    
    if (!username || username.length > 20) throw new Error("Имя пользователя должно быть от 1 до 20 символов");
    if (bio.length > 200) throw new Error("Биография не должна превышать 200 символов");
    if (avatar && !isValidUrl(avatar)) throw new Error("Некорректный URL аватара");
    if (profileBackground && !isValidUrl(profileBackground)) throw new Error("Некорректный URL фонового изображения");
    const updateData = {
      username,
      bio,
      avatar: avatar || '',
      profileBackground: profileBackground || ''
    };
    await updateDoc(doc(db, 'users', currentUser.uid), updateData);
    
    alert("Профиль обновлен");
    window.loadProfile(currentUser.uid);
  } catch (error) {
    console.error("Profile update failed:", error);
    alert(`Ошибка обновления профиля: ${error.message}`);
  }
};

window.changePassword = async function(newPassword) {
  try {
    
    await rateLimit('password_change');
    await updatePassword(currentUser, newPassword);
    alert("Пароль успешно изменен");
    window.showSection('settings');
  } catch (error) {
    console.error("Password change failed:", error);
    alert(`Ошибка смены пароля: ${error.message}`);
  }
};

window.updateMessagingPrivacy = async function(privacy) {
  try {
    
    await updateDoc(doc(window.db, 'users', currentUser.uid), {
      messagingPrivacy: privacy
    });
    alert("Настройки приватности обновлены");
    window.showSection('settings');
  } catch (error) {
    console.error("Messaging privacy update failed:", error);
    alert(`Ошибка обновления настроек приватности: ${error.message}`);
  }
};

window.updateTheme = async function(theme) {
  try {
    
    if (!['light', 'dark'].includes(theme)) throw new Error("Некорректная тема");
    await updateDoc(doc(db, 'users', currentUser.uid), { theme });
    document.documentElement.className = theme;
    
    alert("Тема обновлена");
    window.showSection('settings');
  } catch (error) {
    console.error("Theme update failed:", error);
    alert(`Ошибка обновления темы: ${error.message}`);
  }
};

function showSettings() {
  
  getDoc(doc(db, 'users', currentUser.uid)).then(doc => {
    const user = doc.exists() ? doc.data() : { messagingPrivacy: 'everyone', theme: 'light' };
    
    document.getElementById('content').innerHTML = `
      <div class="auth-form max-w-md mx-auto bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Настройки</h2>
        <form onsubmit="event.preventDefault(); window.changePassword(document.getElementById('newPassword').value)">
          <input id="newPassword" type="password" placeholder="Новый пароль" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2 w-full">Сменить пароль</button>
        </form>
        <form onsubmit="event.preventDefault(); window.updateMessagingPrivacy(document.getElementById('messagingPrivacy').value)" class="mt-4">
          <label for="messagingPrivacy" class="block mb-2 text-gray-900 dark:text-white">Кто может писать:</label>
          <select id="messagingPrivacy" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <option value="everyone" ${user.messagingPrivacy === 'everyone' ? 'selected' : ''}>Все</option>
            <option value="friends" ${user.messagingPrivacy === 'friends' ? 'selected' : ''}>Только друзья</option>
          </select>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2 w-full">Сохранить</button>
        </form>
        <form onsubmit="event.preventDefault(); window.updateTheme(document.getElementById('theme').value)" class="mt-4">
          <label for="theme" class="block mb-2 text-gray-900 dark:text-white">Тема:</label>
          <select id="theme" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            <option value="light" ${user.theme === 'light' ? 'selected' : ''}>Светлая</option>
            <option value="dark" ${user.theme === 'dark' ? 'selected' : ''}>Темная</option>
          </select>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2 w-full">Сохранить</button>
        </form>
      </div>
    `;
  }).catch(error => {
    console.error("Settings load failed:", error);
    alert(`Ошибка загрузки настроек: ${error.message}`);
  });
}
  </script>
  <script>
    const sidebar = document.getElementById('sidebar');
    const sidebarOpen = document.getElementById('sidebar-open');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    sidebarOpen.addEventListener('click', () => {
      sidebar.classList.remove('sidebar-hidden');
    });
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.add('sidebar-hidden');
    });
  </script>
</body>
</html>